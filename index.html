<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø¦Ù…ØªÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #00cec9;
            --dark-bg: #0a0b10;
            --darker-bg: #12141d;
            --card-bg: #1a1c26;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border-color: #2d2f3f;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --accent-color: #e84393;
        }

        body.theme-netflix { --primary-color: #e50914; --secondary-color: #221f1f; }
        body.theme-disney { --primary-color: #0063e5; --secondary-color: #040714; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: var(--dark-bg); color: var(--text-primary); min-height: 100vh; padding: 20px; transition: all 0.4s ease; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(145deg, var(--darker-bg), var(--card-bg)); border-radius: 24px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        
        .top-controls { position: absolute; top: 20px; left: 20px; display: flex; gap: 10px; }
        .theme-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid white; }

        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--border-color); }
        .stat-value { font-size: 1.5em; font-weight: 800; color: var(--primary-color); }
        .stat-label { font-size: 0.8em; color: var(--text-secondary); }

        .search-container { background: var(--card-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        .search-input { width: 100%; padding: 12px 20px; border-radius: 12px; border: 2px solid var(--border-color); background: var(--dark-bg); color: white; font-family: inherit; font-size: 1.1em; margin-bottom: 15px; }
        .advanced-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .filter-select { background: var(--dark-bg); color: white; border: 1px solid var(--border-color); padding: 10px; border-radius: 10px; font-family: inherit; }
        .search-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }

        .filter-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 20px; border-radius: 10px; border: 2px solid var(--border-color); background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 700; transition: 0.3s; font-family: inherit; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        .section-title { font-size: 1.4em; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 700; border-right: 4px solid var(--primary-color); padding-right: 10px; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px; }
        
        .card { background: var(--card-bg); border-radius: 20px; overflow: hidden; border: 1px solid var(--border-color); transition: 0.3s; position: relative; display: flex; flex-direction: column; cursor: pointer; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-poster-wrapper { position: relative; height: 320px; width: 100%; }
        .card-poster { height: 100%; width: 100%; object-fit: cover; }
        .global-rating-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: var(--warning-color); padding: 4px 10px; border-radius: 10px; font-size: 0.85em; font-weight: 800; }
        
        .card-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 5px; margin-bottom: 5px; }
        .card-title { font-weight: 700; font-size: 1em; line-height: 1.4; flex: 1; }
        .copy-btn { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); padding: 5px; border-radius: 6px; cursor: pointer; }
        
        .card-genres { font-size: 0.75em; color: var(--secondary-color); margin-bottom: 10px; font-weight: 600; }
        .rating-section { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: rgba(255,255,255,0.03); padding: 5px 10px; border-radius: 8px; }
        .rating { color: var(--warning-color); cursor: pointer; font-size: 1.1em; }
        
        .progress-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
        .controls { display: flex; gap: 5px; margin-top: auto; flex-wrap: wrap; }
        .btn { flex: 1; padding: 8px; border: none; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 700; transition: 0.2s; font-size: 0.85em; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-add { background: var(--primary-color); color: white; }
        .btn-plus { background: var(--success-color); color: white; }
        .btn-minus { background: #555; color: white; }
        .btn-del { background: #ff4757; color: white; }
        .btn-watch { background: #ff0000; color: white; text-decoration: none; }
        
        .ai-box { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); padding: 30px 20px; border-radius: 25px; margin: 30px 0; text-align: center; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3); }
        .btn-ai { background: white; color: #6c5ce7; padding: 12px 30px; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; font-size: 1.1em; transition: 0.3s; }
        .btn-ai:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(255,255,255,0.4); }
        .btn-ai:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .horizontal-scroll { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 15px; scrollbar-width: none; }
        .mini-card { min-width: 150px; max-width: 150px; background: var(--card-bg); border-radius: 15px; overflow: hidden; border: 1px solid var(--border-color); transition: 0.3s; cursor: pointer; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); border-radius: 25px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--primary-color); position: relative; box-shadow: 0 0 50px rgba(108, 92, 231, 0.3); }
        .close-modal { position: absolute; top: 15px; right: 20px; color: white; font-size: 28px; cursor: pointer; z-index: 10; background: rgba(0,0,0,0.5); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        
        .modal-body { padding: 25px; }
        .modal-poster { width: 100%; height: 350px; object-fit: cover; border-radius: 20px; margin-bottom: 20px; }
        .modal-title { font-size: 1.8em; font-weight: 800; margin-bottom: 10px; color: var(--primary-color); }
        .modal-meta { display: flex; gap: 15px; margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary); }
        .modal-overview { line-height: 1.6; margin-bottom: 20px; color: #eee; }
        .cast-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 10px; }
        .cast-item { min-width: 80px; text-align: center; }
        .cast-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid var(--primary-color); }
        .cast-name { font-size: 0.7em; color: var(--text-secondary); }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary-color); padding: 10px 25px; border-radius: 50px; display: none; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: white; font-weight: 700; }

        @media (max-width: 600px) {
            .cards-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .card-poster-wrapper { height: 220px; }
            .modal-poster { height: 250px; }
        }
    </style>
</head>
<body id="body">
    <div class="container">
        <header class="header">
            <h1>Ù‚Ø§Ø¦Ù…ØªÙŠ</h1>
            <div class="top-controls">
                <div class="theme-dot" style="background: #6c5ce7" onclick="setTheme('default')"></div>
                <div class="theme-dot" style="background: #e50914" onclick="setTheme('netflix')"></div>
                <div class="theme-dot" style="background: #0063e5" onclick="setTheme('disney')"></div>
            </div>
        </header>

        <div class="stats-bar" id="statsBar"></div>

        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ÙÙŠÙ„Ù… Ø£Ùˆ Ù…Ø³Ù„Ø³Ù„...">
            <div class="advanced-filters">
                <select id="filterGenre" class="filter-select"><option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option></select>
                <select id="filterYear" class="filter-select"><option value="">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option></select>
                <select id="filterLang" class="filter-select">
                    <option value="">ÙƒÙ„ Ø§Ù„Ù„ØºØ§Øª</option>
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="en">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                    <option value="ko">Ø§Ù„ÙƒÙˆØ±ÙŠØ©</option>
                </select>
            </div>
            <button class="btn btn-add" onclick="performAdvancedSearch()" style="width:100%; padding:12px">Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù… ğŸ”</button>
            <div id="searchResults" class="search-results"></div>
        </div>

        <div class="filter-controls">
            <button class="filter-btn active" onclick="setFilter('all')">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" onclick="setFilter('movie')">ğŸ¬ Ø£ÙÙ„Ø§Ù…</button>
            <button class="filter-btn" onclick="setFilter('tv')">ğŸ“º Ù…Ø³Ù„Ø³Ù„Ø§Øª</button>
        </div>

        <section>
            <h2 class="section-title">ğŸ”¥ Ø£Ø´Ø§Ù‡Ø¯Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
            <div id="watchingNow" class="cards-grid"></div>
        </section>

        <div class="ai-box">
            <h3 style="margin-bottom:10px; color:white">ğŸ§  Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
            <p style="color:rgba(255,255,255,0.8); font-size:0.9em; margin-bottom:20px">Ø³Ø£Ø­Ù„Ù„ Ø°ÙˆÙ‚Ùƒ ÙˆØ£Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙƒ ÙÙŠÙ„Ù… Ø§Ù„Ø³Ù‡Ø±Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ!</p>
            <button id="aiBtn" class="btn-ai" onclick="aiRecommendation()">Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø­Ø³Ø¨ Ø°ÙˆÙ‚ÙŠ âœ¨</button>
        </div>

        <section>
            <h2 class="section-title">â³ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
            <div id="watchlist" class="cards-grid"></div>
        </section>

        <section>
            <h2 class="section-title">âœ… Ø§Ù„Ù…ÙƒØªÙ…Ù„</h2>
            <div id="completed" class="cards-grid"></div>
        </section>

        <section class="rec-section">
            <h2 class="section-title">âœ¨ Ø§Ù„Ø±Ø§Ø¦Ø¬ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹</h2>
            <div id="trendingMovies" class="horizontal-scroll"></div>
        </section>
    </div>

    <!-- Modal for Details -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalBody" class="modal-body">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const API_KEY = '2c4b40bf95c49f133a6c50ea7269f95b';
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        
        const GENRES = { 28: "Ø£ÙƒØ´Ù†", 12: "Ù…ØºØ§Ù…Ø±Ø©", 16: "Ø£Ù†ÙŠÙ…ÙŠØ´Ù†", 35: "ÙƒÙˆÙ…ÙŠØ¯ÙŠ", 80: "Ø¬Ø±ÙŠÙ…Ø©", 99: "ÙˆØ«Ø§Ø¦Ù‚ÙŠ", 18: "Ø¯Ø±Ø§Ù…Ø§", 10751: "Ø¹Ø§Ø¦Ù„ÙŠ", 14: "Ø®ÙŠØ§Ù„", 36: "ØªØ§Ø±ÙŠØ®", 27: "Ø±Ø¹Ø¨", 10402: "Ù…ÙˆØ³ÙŠÙ‚Ù‰", 9648: "ØºÙ…ÙˆØ¶", 10749: "Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©", 878: "Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ", 10770: "ÙÙŠÙ„Ù… ØªÙ„ÙØ²ÙŠÙˆÙ†ÙŠ", 53: "Ø¥Ø«Ø§Ø±Ø©", 10752: "Ø­Ø±Ø¨", 37: "ÙˆØ³ØªØ±Ù†", 10759: "Ø£ÙƒØ´Ù† ÙˆÙ…ØºØ§Ù…Ø±Ø©", 10762: "Ø£Ø·ÙØ§Ù„", 10763: "Ø£Ø®Ø¨Ø§Ø±", 10764: "ÙˆØ§Ù‚Ø¹", 10765: "Ø®ÙŠØ§Ù„ ÙˆØ¹Ù„Ù…ÙŠ", 10766: "Ø£ÙˆØ¨Ø±Ø§ ØµØ§Ø¨ÙˆÙ†ÙŠØ©", 10767: "Ø­ÙˆØ§Ø±", 10768: "Ø­Ø±Ø¨ ÙˆØ³ÙŠØ§Ø³Ø©" };

        let state = { watching: [], watchlist: [], completed: [], theme: 'default', filter: 'all' };

        function init() {
            const saved = localStorage.getItem('myWatchlistFinal');
            if (saved) state = JSON.parse(saved);
            setTheme(state.theme || 'default');
            populateFilterOptions();
            fetchTrending();
            render();
        }

        function save() {
            localStorage.setItem('myWatchlistFinal', JSON.stringify(state));
            render();
        }

        function setTheme(t) {
            state.theme = t;
            document.getElementById('body').className = t === 'default' ? '' : 'theme-' + t;
            save();
        }

        function setFilter(f) {
            state.filter = f;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (event) event.target.classList.add('active');
            render();
        }

        function populateFilterOptions() {
            const genreSelect = document.getElementById('filterGenre');
            Object.entries(GENRES).forEach(([id, name]) => {
                const opt = document.createElement('option');
                opt.value = id; opt.textContent = name;
                genreSelect.appendChild(opt);
            });
            const yearSelect = document.getElementById('filterYear');
            for (let y = 2025; y >= 1980; y--) {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = y;
                yearSelect.appendChild(opt);
            }
        }

        async function fetchTrending() {
            try {
                const res = await fetch(`${BASE_URL}/trending/all/day?api_key=${API_KEY}&language=ar`);
                const data = await res.json();
                document.getElementById('trendingMovies').innerHTML = data.results.map(i => `
                    <div class="mini-card" onclick='showDetails(${JSON.stringify(i).replace(/'/g, "&apos;")})'>
                        <img src="${IMG_URL + i.poster_path}" style="width:100%; height:200px; object-fit:cover">
                        <div style="padding:8px; font-size:0.75em; font-weight:bold; text-align:center; height:3em; overflow:hidden">${i.title || i.name}</div>
                    </div>
                `).join('');
            } catch(e) {}
        }

        async function performAdvancedSearch() {
            const q = document.getElementById('searchInput').value;
            const g = document.getElementById('filterGenre').value;
            const y = document.getElementById('filterYear').value;
            const l = document.getElementById('filterLang').value;

            let url = `${BASE_URL}/discover/movie?api_key=${API_KEY}&language=ar&sort_by=popularity.desc`;
            if (q) url = `${BASE_URL}/search/multi?api_key=${API_KEY}&language=ar&query=${encodeURIComponent(q)}`;
            else {
                if (g) url += `&with_genres=${g}`;
                if (y) url += `&primary_release_year=${y}`;
                if (l) url += `&with_original_language=${l}`;
            }

            const res = await fetch(url);
            const data = await res.json();
            document.getElementById('searchResults').innerHTML = data.results.filter(i => i.poster_path).slice(0, 12).map(i => `
                <div class="card" style="height: auto; padding: 5px;" onclick='showDetails(${JSON.stringify(i).replace(/'/g, "&apos;")})'>
                    <img src="${IMG_URL + i.poster_path}" style="width:100%; height:180px; object-fit:cover; border-radius:10px">
                    <div style="padding:10px">
                        <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 5px; height:2.4em; overflow:hidden">${i.title || i.name}</div>
                        <button class="btn btn-add" style="font-size:0.75em" onclick='event.stopPropagation(); addItem(${JSON.stringify(i).replace(/'/g, "&apos;")})'>Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </div>
            `).join('');
        }

        async function showDetails(i) {
            const modal = document.getElementById('detailsModal');
            const type = i.media_type || (i.title ? 'movie' : 'tv');
            
            // Fetch Cast
            let castHtml = '';
            try {
                const castRes = await fetch(`${BASE_URL}/${type}/${i.id}/credits?api_key=${API_KEY}&language=ar`);
                const castData = await castRes.json();
                castHtml = castData.cast.slice(0, 8).map(c => `
                    <div class="cast-item">
                        <img src="${c.profile_path ? IMG_URL + c.profile_path : 'https://via.placeholder.com/60'}" class="cast-img">
                        <div class="cast-name">${c.name}</div>
                    </div>
                `).join('');
            } catch(e) {}

            document.getElementById('modalBody').innerHTML = `
                <img src="${IMG_URL + i.poster_path}" class="modal-poster">
                <div class="modal-title">${i.title || i.name}</div>
                <div class="modal-meta">
                    <span>â­ ${i.vote_average ? i.vote_average.toFixed(1) : 'N/A'}</span>
                    <span>ğŸ“… ${i.release_date || i.first_air_date || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
                    <span>ğŸ¬ ${type === 'movie' ? 'ÙÙŠÙ„Ù…' : 'Ù…Ø³Ù„Ø³Ù„'}</span>
                </div>
                <div class="modal-overview">${i.overview || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.'}</div>
                <h4 style="margin-bottom:10px">ğŸ‘¥ Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„:</h4>
                <div class="cast-list">${castHtml || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div>
                <div style="margin-top:25px; display:flex; gap:10px">
                    <button class="btn btn-add" onclick='addItem(${JSON.stringify(i).replace(/'/g, "&apos;")}); closeModal();'>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent((i.title || i.name) + ' trailer')}" target="_blank" class="btn btn-watch">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ğŸ¬</a>
                </div>
            `;
            modal.style.display = 'flex';
        }

        async function aiRecommendation() {
            const btn = document.getElementById('aiBtn');
            btn.disabled = true;
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„... â³';
            
            try {
                const allItems = [...state.watching, ...state.watchlist, ...state.completed];
                let topGenre = '';
                
                if (allItems.length > 0) {
                    const genreCounts = {};
                    allItems.forEach(item => {
                        if (item.genre_ids) {
                            item.genre_ids.forEach(id => genreCounts[id] = (genreCounts[id] || 0) + 1);
                        }
                    });
                    topGenre = Object.keys(genreCounts).reduce((a, b) => genreCounts[a] > genreCounts[b] ? a : b, '');
                }

                let url = `${BASE_URL}/discover/movie?api_key=${API_KEY}&language=ar&sort_by=popularity.desc&page=${Math.floor(Math.random()*5)+1}`;
                if (topGenre) url += `&with_genres=${topGenre}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    const i = data.results[Math.floor(Math.random()*data.results.length)];
                    showDetails(i);
                    showMsg(topGenre ? 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù‚ØªØ±Ø§Ø­ ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ! âœ¨' : 'Ø¥Ù„ÙŠÙƒ Ø§Ù‚ØªØ±Ø§Ø­ Ø±Ø§Ø¦Ø¹ Ù…Ù† Ø§Ù„Ø£ÙÙ„Ø§Ù… Ø§Ù„Ø±Ø§Ø¦Ø¬Ø©! âœ¨');
                } else {
                    showMsg('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Ù‹ Ø­Ø§Ù„ÙŠØ§Ù‹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!');
                }
            } catch(e) {
                showMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ø§Ù‚ØªØ±Ø­ Ù„ÙŠ Ø­Ø³Ø¨ Ø°ÙˆÙ‚ÙŠ âœ¨';
            }
        }

        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showMsg('ØªÙ… Ù†Ø³Ø®: ' + text));
        }

        function showMsg(m) {
            const t = document.getElementById('toast');
            t.textContent = m; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function addItem(i) {
            const item = {
                id: i.id, title: i.title || i.name, type: i.media_type || (i.title ? 'movie' : 'tv'),
                poster: i.poster_path, globalRating: i.vote_average,
                genre_ids: i.genre_ids || [],
                genres: i.genre_ids ? i.genre_ids.slice(0,2).map(id => GENRES[id]).join(' - ') : 'ØºÙŠØ± Ù…ØµÙ†Ù',
                season: 1, ep: 1, rating: 0, added: new Date().getTime(), completed: null
            };
            if ([...state.watching, ...state.watchlist, ...state.completed].some(x => x.id === i.id)) return showMsg('Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!');
            state.watchlist.push(item);
            save();
            showMsg('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“');
        }

        function render() {
            const filter = (list) => list.filter(i => state.filter === 'all' || i.type === state.filter);
            const watching = filter(state.watching);
            const watchlist = filter(state.watchlist);
            const completed = filter(state.completed);
            
            document.getElementById('statsBar').innerHTML = `
                <div class="stat-card"><div class="stat-value">${state.watching.length + state.watchlist.length + state.completed.length}</div><div class="stat-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
                <div class="stat-card"><div class="stat-value">${state.watching.length}</div><div class="stat-label">Ø£Ø´Ø§Ù‡Ø¯Ù‡</div></div>
                <div class="stat-card"><div class="stat-value">${state.completed.length}</div><div class="stat-label">Ù…ÙƒØªÙ…Ù„</div></div>
            `;

            const renderCard = (i, list) => `
                <div class="card" onclick='showDetails(${JSON.stringify(i).replace(/'/g, "&apos;")})'>
                    <div class="card-poster-wrapper">
                        <img src="${IMG_URL + i.poster}" class="card-poster">
                        <div class="global-rating-badge">â­ ${i.globalRating ? i.globalRating.toFixed(1) : 'N/A'}</div>
                    </div>
                    <div class="card-content">
                        <div class="card-title-row">
                            <div class="card-title">${i.title}</div>
                            <button class="copy-btn" onclick="event.stopPropagation(); copyToClipboard('${i.title}')">ğŸ“‹</button>
                        </div>
                        <div class="card-genres">${i.genres}</div>
                        <div class="rating-section" onclick="event.stopPropagation()">
                            <div class="rating" onclick="setRating(${i.id}, ((${i.rating}+1)%6), '${list}')">
                                ${'â˜…'.repeat(i.rating)}${'â˜†'.repeat(5-i.rating)}
                            </div>
                        </div>
                        ${list === 'watching' ? `
                            <div class="progress-box" onclick="event.stopPropagation()">
                                ${i.type==='tv' ? `
                                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9em">
                                        <span>Ø§Ù„Ù…ÙˆØ³Ù…: <input type="number" value="${i.season}" onchange="updateSeason(${i.id}, this.value)" style="width:50px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white; text-align:center; border-radius:8px"></span>
                                        <span>Ø§Ù„Ø­Ù„Ù‚Ø©: <b style="color:var(--secondary-color)">${i.ep}</b></span>
                                    </div>
                                ` : '<div style="text-align:center; font-size:0.9em; color:var(--secondary-color)">ğŸ¬ ÙÙŠÙ„Ù… Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ</div>'}
                            </div>
                        ` : ''}
                        <div class="controls" onclick="event.stopPropagation()">
                            ${list === 'watching' ? `
                                ${i.type==='tv' ? `
                                    <button class="btn btn-plus" onclick="updateEp(${i.id}, 1)">+1</button>
                                    <button class="btn btn-minus" onclick="updateEp(${i.id}, -1)">-1</button>
                                ` : ''}
                                <button class="btn btn-plus" style="background:var(--success-color)" onclick="markCompleted(${i.id})">ØªÙ… âœ…</button>
                            ` : ''}
                            ${list === 'watchlist' ? `<button class="btn btn-add" onclick="startWatch(${i.id})">Ø¨Ø¯Ø¡</button>` : ''}
                            ${list === 'completed' ? `<button class="btn btn-minus" onclick="undoCompleted(${i.id})">Ø¥Ø¹Ø§Ø¯Ø©</button>` : ''}
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(i.title + ' trailer')}" target="_blank" class="btn btn-watch">ğŸ¬</a>
                            <button class="btn btn-del" onclick="delItem(${i.id}, '${list}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('watchingNow').innerHTML = watching.map(i => renderCard(i, 'watching')).join('') || '<div style="text-align:center; padding:20px; color:var(--text-secondary); grid-column: 1/-1;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
            document.getElementById('watchlist').innerHTML = watchlist.map(i => renderCard(i, 'watchlist')).join('') || '<div style="text-align:center; padding:20px; color:var(--text-secondary); grid-column: 1/-1;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©</div>';
            document.getElementById('completed').innerHTML = completed.map(i => renderCard(i, 'completed')).join('') || '<div style="text-align:center; padding:20px; color:var(--text-secondary); grid-column: 1/-1;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØªÙ…Ù„</div>';
        }

        function startWatch(id) {
            const idx = state.watchlist.findIndex(x => x.id === id);
            state.watching.push(state.watchlist.splice(idx, 1)[0]);
            save();
        }

        function markCompleted(id) {
            const idx = state.watching.findIndex(x => x.id === id);
            const item = state.watching.splice(idx, 1)[0];
            item.completed = new Date().toLocaleDateString('ar-SA');
            state.completed.push(item);
            save();
        }

        function undoCompleted(id) {
            const idx = state.completed.findIndex(x => x.id === id);
            const item = state.completed.splice(idx, 1)[0];
            item.completed = null;
            state.watching.push(item);
            save();
        }

        function updateEp(id, d) {
            const item = state.watching.find(x => x.id === id);
            item.ep = Math.max(1, item.ep + d);
            save();
        }

        function updateSeason(id, v) {
            const item = state.watching.find(x => x.id === id);
            item.season = Math.max(1, parseInt(v) || 1);
            save();
        }

        function setRating(id, r, list) {
            state[list].find(x => x.id === id).rating = r;
            save();
        }

        function delItem(id, list) {
            state[list] = state[list].filter(x => x.id !== id);
            save();
        }

        init();
    </script>
</body>
</html>
